<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Keyword Scavenger Hunt</title>

<style>
body { font-family: system-ui, sans-serif; background:#f4f6f8; padding:20px; }
.card { max-width:900px; margin:auto; background:#fff; padding:20px; border-radius:12px; }
.hunt { border:1px solid #ddd; padding:12px; border-radius:8px; margin-bottom:12px; }
button { padding:8px 14px; margin:4px; }
input, textarea { width:100%; padding:8px; margin-bottom:8px; }
.overlay {
  position:fixed; inset:0;
  background:rgba(0,0,0,.6);
  display:none;
  justify-content:center;
  align-items:center;
  color:#fff;
  font-size:24px;
  z-index:1000;
}
</style>
</head>

<body>
<div class="card" id="app"></div>
<div class="overlay" id="overlay">‚ùå Wrong Keyword! Try Again...</div>

<script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

<script>
/* ================= HELPERS ================= */
function uid(){ return Math.random().toString(36).slice(2,9); }

/* ================= BASE HUNTS ================= */
const DEFAULT_HUNTS = {
  escape: {
    name: "Escape the House",
    intro: "Welcome! Your escape challenge begins now üè†",
    clues: [
      { clue: "I show your face but I'm not a photo.", keyword: "mirror" },
      { clue: "I have pages but no homework.", keyword: "book" },
      { clue: "I keep food safe and cold.", keyword: "fridge" }
    ],
    finish: "üéâ Congratulations! You escaped the house!"
  }
};

/* ================= STORAGE ================= */
let userHunts = JSON.parse(localStorage.getItem("userHunts") || "{}");

/* üîß FIX: persist base hunts so QR/PDF works */
Object.keys(DEFAULT_HUNTS).forEach(k=>{
  if(!userHunts[k]) userHunts[k]=DEFAULT_HUNTS[k];
});
localStorage.setItem("userHunts", JSON.stringify(userHunts));

let HUNTS = { ...DEFAULT_HUNTS, ...userHunts };

const app = document.getElementById("app");
const q = new URLSearchParams(location.search);

/* ================= ROUTER ================= */
if(q.get("play")) play();
else if(q.get("edit")) editHunt(q.get("edit"));
else if(q.get("new")) editHunt();
else home();

/* ================= HOME ================= */
function home(){
  app.innerHTML = `
    <h1>Keyword Scavenger Hunts</h1>
    <button onclick="location='?new=1'">‚ûï Create Hunt</button>
    ${Object.entries(HUNTS).map(([k,h])=>`
      <div class="hunt">
        <h3>${h.name}</h3>
        <button onclick="location='?play=${k}&s=0'">‚ñ∂ Start</button>
        <button onclick="location='?edit=${k}'">‚úè Edit</button>
        <button onclick="generatePDF('${k}')">üñ® PDF / QR</button>
      </div>
    `).join("")}
  `;
}

/* ================= CREATE / EDIT ================= */
function editHunt(k){
  const h = k ? HUNTS[k] : { name:"", intro:"", clues:[], finish:"" };

  app.innerHTML = `
    <h2>${k?"Edit":"Create"} Hunt</h2>
    <input id="name" placeholder="Name" value="${h.name}">
    <textarea id="intro" placeholder="Intro">${h.intro}</textarea>
    <div id="clues"></div>
    <button onclick="addClue()">‚ûï Add Clue</button>
    <textarea id="finish" placeholder="Finish">${h.finish}</textarea>
    <button onclick="saveHunt('${k||""}')">üíæ Save</button>
    <button onclick="home()">Cancel</button>
  `;
  h.clues.forEach(c=>addClue(c.clue,c.keyword));
}

function addClue(clue="",keyword=""){
  const d=document.createElement("div");
  d.className="clue-item";
  d.innerHTML=`
    <textarea placeholder="Clue">${clue}</textarea>
    <input placeholder="Keyword" value="${keyword}">
  `;
  document.getElementById("clues").appendChild(d);
}

function saveHunt(k){
  const name=document.getElementById("name").value.trim();
  const intro=document.getElementById("intro").value.trim();
  const finish=document.getElementById("finish").value.trim();

  const clues=[...document.querySelectorAll(".clue-item")]
    .map(d=>({
      clue:d.querySelector("textarea").value.trim(),
      keyword:d.querySelector("input").value.trim().toLowerCase()
    }))
    .filter(c=>c.clue && c.keyword);

  if(!name||!intro||!finish||!clues.length){
    alert("All fields required"); return;
  }

  if(!k) k=uid();
  userHunts[k]={name,intro,clues,finish};
  localStorage.setItem("userHunts", JSON.stringify(userHunts));
  HUNTS={...DEFAULT_HUNTS,...userHunts};
  home();
}

/* ================= PLAY ================= */
function play(){
  const key=q.get("play");
  const h=HUNTS[key];
  const step=parseInt(q.get("s")||0);

  if(step===0){
    return render(h.intro,"start");
  }

  if(step<=h.clues.length){
    const c=h.clues[step-1];
    return render(c.clue,c.keyword);
  }

  render(h.finish,null);
}

function render(text,keyword){
  app.innerHTML=`
    <p>${text}</p>
    ${keyword?`
      <input id="ans" placeholder="Enter keyword">
      <button onclick="check('${keyword}')">Submit</button>
    `:""}
  `;
}

function check(k){
  const v=document.getElementById("ans").value.trim().toLowerCase();
  if(v===k){
    const n=parseInt(q.get("s"))+1;
    location=`?play=${q.get("play")}&s=${n}`;
  }else{
    overlay.style.display="flex";
    document.getElementById("ans").value="";
    setTimeout(()=>overlay.style.display="none",2000);
  }
}

/* ================= PDF / QR ================= */
async function generatePDF(k){
  const {jsPDF}=window.jspdf;
  const pdf=new jsPDF();
  const h=HUNTS[k];
  const base=location.origin+location.pathname;

  async function page(title,url){
    const c=document.createElement("canvas");
    await QRCode.toCanvas(c,url,{width:300});
    pdf.addPage();
    pdf.text(title,10,20);
    pdf.addImage(c.toDataURL(),"PNG",30,40,150,150);
    pdf.text(url,10,230);
  }

  pdf.text(h.name,10,20);
  pdf.text("Scan QR codes in order",10,30);

  await page("START",`${base}?play=${k}&s=0`);
  for(let i=0;i<h.clues.length;i++){
    await page(`CLUE ${i+1}`,`${base}?play=${k}&s=${i+1}`);
  }
  await page("FINISH",`${base}?play=${k}&s=${h.clues.length+1}`);

  pdf.save(`${h.name}.pdf`);
}
</script>
</body>
</html>