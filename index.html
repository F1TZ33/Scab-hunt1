<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Scavenger Hunt</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
body {
  font-family: system-ui, sans-serif;
  background: linear-gradient(180deg,#eef2f7,#f4f6f8);
  padding:20px;
}

.card {
  max-width:900px;
  margin:auto;
  background:#fff;
  padding:24px;
  border-radius:14px;
}

button {
  padding:14px 20px;
  font-size:18px;
  cursor:pointer;
  border:none;
  border-radius:10px;
}

button.primary {
  background:#2ecc71;
  color:white;
  margin-top:14px;
}

button.secondary {
  background:#2563eb;
  color:white;
  margin:12px 0 18px 0;
}

input {
  padding:14px;
  font-size:18px;
  width:100%;
  max-width:320px;
  margin-top:14px;
  text-align:center;
}

.center { text-align:center; }

.hunt-card {
  padding:16px;
  border-radius:12px;
  background:#f8fafc;
  margin-bottom:14px;
}

.search {
  width:100%;
  padding:12px;
  font-size:16px;
  margin:16px 0;
}

.overlay {
  position:fixed;
  inset:0;
  display:none;
  align-items:center;
  justify-content:center;
  font-size:40px;
  font-weight:bold;
  color:white;
  z-index:1000;
}
.overlay.correct { background:rgba(0,160,0,0.85); }
.overlay.wrong { background:rgba(200,0,0,0.85); }

/* CAMERA */
video {
  width:260px;
  border-radius:12px;
  margin-top:16px;
}

/* PRINT */
.print-page { page-break-after:always; }
.print-item { margin-bottom:20px; }
.notes { border:1px dashed #aaa; height:40px; margin-top:6px; }
.qr-label { font-weight:bold; margin-bottom:6px; }

.print-intro {
  text-align:center;
  margin-top:60px;
}
.print-intro h1 {
  font-size:36px;
  margin-bottom:20px;
}
.print-intro p {
  font-size:18px;
  margin-bottom:20px;
}

.cut-grid {
  display:grid;
  grid-template-columns:repeat(2,1fr);
  gap:20px;
}
.cut-card {
  border:1px dashed #aaa;
  padding:14px;
  border-radius:10px;
  text-align:center;
}

@media print {
  button, .search, video { display:none; }
}
</style>
</head>

<body>

<div class="card" id="app"></div>

<div id="correct" class="overlay correct">‚úÖ Correct!</div>
<div id="wrong" class="overlay wrong">‚ùå Try Again</div>

<script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jsqr/dist/jsQR.js"></script>
<script src="hunts-source.js"></script>

<script>
/* ================= DATA ================= */
const hunts = window.HUNT_SOURCE;
const q = new URLSearchParams(location.search);
const app = document.getElementById("app");

/* ================= ROUTER ================= */
if(q.get("start")) startPage(q.get("start"));
else if(q.get("play")) play();
else if(q.get("print")) printPage(q.get("print"));
else home();

/* ================= HOME ================= */
function home(){
  app.innerHTML = `
    <h1>Scavenger Hunts</h1>

    <input class="search" placeholder="Search hunts...">

    <button class="secondary" onclick="location='create-hunt.html'">
      ‚ûï Create New Hunt
    </button>

    ${hunts.map(h=>`
      <div class="hunt-card">
        <strong>${h.name} (${h.steps.length} steps)</strong><br><br>
        <button onclick="location='?start=${h.id}'">‚ñ∂ Test</button>
        <button onclick="location='?print=${h.id}'">üñ® Print Instructions</button>
      </div>
    `).join("")}
  `;
}

/* ================= INTRO PAGE (VERBATIM) ================= */
function startPage(id){
  const h = hunts.find(x=>x.id===id);
  app.innerHTML = `
<div class="center">
  <h1>üéâ Welcome, Explorer!</h1>
  <p><strong>${h.name}</strong></p>

  <p>
    You have been invited on a special scavenger hunt!<br>
    Around this place are hidden clues waiting to be found.
  </p>

  <ul style="text-align:left;display:inline-block">
    <li>Look carefully</li>
    <li>Think smart</li>
    <li>Scan QR codes or</li>
    <li>Enter the secret code</li>
  </ul>

  <p>When you‚Äôre ready‚Ä¶</p>

  <button class="primary" onclick="location='?play=${id}&s=0'">
    ‚ñ∂Ô∏è Start the Hunt
  </button>
</div>
`;
}

/* ================= PLAY ================= */
function play(){
  const h = hunts.find(x=>x.id===q.get("play"));
  const s = parseInt(q.get("s"));
  if(s >= h.steps.length){
    app.innerHTML = `<h2 class="center">üéâ Hunt Complete!</h2>`;
    return;
  }
  const step = h.steps[s];
  app.innerHTML = `
<div class="center">
  <h2 style="font-size:26px;font-weight:700">${step.clue}</h2>

  <input id="ans" placeholder="Enter code">
  <br>
  <button class="primary" onclick="check('${step.code}',${s})">Submit</button>

  <p><strong>Or scan the QR code:</strong></p>
  <button id="startCam" class="secondary">üì∑ Scan QR Code</button>
  <br>
  <video id="video" autoplay playsinline style="display:none;"></video>
</div>
`;

  document.getElementById("startCam").onclick = () => {
    document.getElementById("startCam").style.display = "none";
    const v = document.getElementById("video");
    v.style.display = "block";
    startScanner(step.code, s);
  };
}

/* ================= CAMERA SCANNER ================= */
function startScanner(expected, s){
  const video = document.getElementById("video");

  navigator.mediaDevices.getUserMedia({ video:{ facingMode:"environment" } })
    .then(stream=>{
      video.srcObject = stream;

      const canvas = document.createElement("canvas");
      const ctx = canvas.getContext("2d");

      const scan = () => {
        if(video.readyState === video.HAVE_ENOUGH_DATA){
          canvas.width = video.videoWidth;
          canvas.height = video.videoHeight;
          ctx.drawImage(video,0,0);
          const img = ctx.getImageData(0,0,canvas.width,canvas.height);
          const qr = jsQR(img.data, canvas.width, canvas.height);
          if(qr && qr.data === expected){
            stream.getTracks().forEach(t=>t.stop());
            show("correct");
            setTimeout(()=>location='?play='+q.get("play")+'&s='+(s+1),900);
            return;
          }
        }
        requestAnimationFrame(scan);
      };
      scan();
    });
}

/* ================= CHECK ================= */
function check(c,s){
  const v=document.getElementById("ans").value.trim();
  if(v===c){
    show("correct");
    setTimeout(()=>location='?play='+q.get("play")+'&s='+(s+1),900);
  } else show("wrong");
}

function show(id){
  const el=document.getElementById(id);
  el.style.display="flex";
  setTimeout(()=>el.style.display="none",1000);
}

/* ================= PRINT (UNCHANGED) ================= */
function printPage(id){
  const h = hunts.find(x=>x.id===id);
  const startURL = location.origin + location.pathname + '?start=' + id;

  app.innerHTML = `
<div class="print-page print-intro">
  <h1>${h.name}</h1>
  <p>Welcome! Scan the QR code below to begin this scavenger hunt.</p>
  <p><strong>Players:</strong> Scan to start</p>
  <canvas id="introQR"></canvas>
</div>

<div class="print-page">
  <h1>${h.name} ‚Äì Parent Instructions</h1>
  ${h.steps.map((s,i)=>`
    <div class="print-item">
      <strong>Clue ${i+1}:</strong> ${s.clue}<br>
      <strong>Location:</strong> ${s.location}<br>
      <strong>Code:</strong> ${s.code}
      <div class="notes"></div>
    </div>
  `).join("")}
</div>

<div class="print-page">
  <h2>Cut-Out Cards</h2>
  <div class="cut-grid">
    ${h.steps.map((s,i)=>`
      <div class="cut-card">
        <strong>Clue ${i+1}</strong><br><br>
        ${s.clue}<br><br>
        Code: <strong>${s.code}</strong><br><br>
        <canvas id="cutqr${i}"></canvas>
      </div>
    `).join("")}
  </div>
</div>

<button onclick="window.print()">Print</button>
`;

  QRCode.toCanvas(document.getElementById("introQR"), startURL, { width:260 });
  h.steps.forEach((s,i)=>{
    QRCode.toCanvas(document.getElementById("cutqr"+i), s.code, { width:120 });
  });
}
</script>

</body>
</html>